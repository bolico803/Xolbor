<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xolbor - Marketplace</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo-icon"><i class="fas fa-gamepad"></i></span>
            <h2>XOLBOR</h2>
        </div>
        
        <div class="search-bar">
            <input type="text" id="skin-search" placeholder="Rechercher un skin...">
        </div>
        
        <div class="profile-section">
            <div class="xubor-balance">
                <i class="fas fa-gem"></i>
                <span id="xubor-balance">0</span>
            </div>
            
            <div class="avatar-container" onclick="window.location.href='profile.html'">
                <div class="avatar">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=user&backgroundColor=6C63FF" alt="Avatar">
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Menu de navigation -->
    <div class="nav-menu-container">
        <div class="nav-menu">
            <button class="nav-btn" onclick="window.location.href='home.html'">
                <i class="fas fa-home"></i> Accueil
            </button>
            <button class="nav-btn active" onclick="window.location.href='marketplace.html'">
                <i class="fas fa-store"></i> Marketplace
            </button>
            <button class="nav-btn" onclick="window.location.href='friends.html'">
                <i class="fas fa-user-friends"></i> Amis
            </button>
            <button class="nav-btn" onclick="window.location.href='profile.html'">
                <i class="fas fa-user"></i> Profil
            </button>
            <button class="nav-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </button>
        </div>
    </div>
    
    <!-- Contenu principal -->
    <main class="main-content">
        <!-- En-tête marketplace -->
        <div class="marketplace-header">
            <div class="section-header">
                <h1>Marketplace des Skins</h1>
                <div class="filter-controls">
                    <select id="category-filter">
                        <option value="all">Toutes les catégories</option>
                        <option value="legendary">Légendaire</option>
                        <option value="epic">Épique</option>
                        <option value="rare">Rare</option>
                        <option value="common">Commun</option>
                    </select>
                    
                    <select id="price-filter">
                        <option value="all">Tous les prix</option>
                        <option value="low">Moins de 100 Xubor</option>
                        <option value="medium">100-500 Xubor</option>
                        <option value="high">Plus de 500 Xubor</option>
                    </select>
                    
                    <button class="btn-refresh" onclick="loadSkins()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-label">Skins disponibles</span>
                    <span class="stat-value" id="skin-count">127</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Vos skins</span>
                    <span class="stat-value" id="owned-count">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Promotions</span>
                    <span class="stat-value" id="discount-count">12</span>
                </div>
            </div>
        </div>
        
        <!-- Grille des skins -->
        <div class="skins-grid" id="skins-container">
            <!-- Les skins seront chargés dynamiquement -->
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des skins...</p>
            </div>
        </div>
        
        <!-- Bouton pour charger plus -->
        <div class="load-more">
            <button class="btn-load-more" onclick="loadMoreSkins()">
                <i class="fas fa-plus"></i> Charger plus de skins
            </button>
        </div>
        
        <!-- Section promotions -->
        <div class="promotions-section">
            <div class="section-header">
                <h2><i class="fas fa-fire"></i> Promotions du jour</h2>
            </div>
            
            <div class="promotions-grid">
                <div class="promotion-card">
                    <div class="promotion-badge">-50%</div>
                    <div class="skin-card">
                        <div class="skin-image" style="background: linear-gradient(135deg, #F59E0B, #F97316);">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="skin-info">
                            <h3 class="skin-name">Golden King</h3>
                            <div class="skin-price">
                                <s>2000 Xubor</s>
                                <span style="color: var(--success);">1000 Xubor</span>
                            </div>
                            <button class="buy-btn">ACHETER</button>
                        </div>
                    </div>
                </div>
                
                <div class="promotion-card">
                    <div class="promotion-badge">-30%</div>
                    <div class="skin-card">
                        <div class="skin-image" style="background: linear-gradient(135deg, #3B82F6, #1D4ED8);">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="skin-info">
                            <h3 class="skin-name">Cyber Sentinel</h3>
                            <div class="skin-price">
                                <s>700 Xubor</s>
                                <span style="color: var(--success);">490 Xubor</span>
                            </div>
                            <button class="buy-btn">ACHETER</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Panier flottant -->
    <div class="floating-cart" id="floating-cart">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-cart"></i> Votre panier</h3>
            <span class="cart-count">0</span>
        </div>
        <div class="cart-items" id="cart-items">
            <p class="empty-cart">Votre panier est vide</p>
        </div>
        <div class="cart-total">
            <span>Total:</span>
            <span class="total-amount">0 Xubor</span>
        </div>
        <button class="btn-checkout" onclick="window.location.href='checkout.html'">
            <i class="fas fa-credit-card"></i> Procéder au paiement
        </button>
    </div>
    
    <script src="auth.js"></script>
    <script src="script.js"></script>
    <script>
        let skins = [];
        let filteredSkins = [];
        let displayedCount = 20;
        let cart = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier l'authentification
            if (!window.authManager.isLoggedIn()) {
                window.location.href = 'index.html';
                return;
            }
            
            // Charger les données
            loadUserData();
            loadSkins();
            loadCart();
            
            // Configurer la recherche
            const searchInput = document.getElementById('skin-search');
            searchInput.addEventListener('input', debounce(function() {
                filterSkins();
            }, 300));
            
            // Configurer les filtres
            document.getElementById('category-filter').addEventListener('change', filterSkins);
            document.getElementById('price-filter').addEventListener('change', filterSkins);
        });
        
        function loadUserData() {
            const user = window.authManager.getCurrentUser();
            if (user) {
                document.getElementById('xubor-balance').textContent = 
                    (user.xuborBalance || 0).toLocaleString();
                
                const avatarImg = document.querySelector('.avatar img');
                if (avatarImg && user.username) {
                    avatarImg.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.username}&backgroundColor=6C63FF`;
                }
            }
        }
        
        async function loadSkins() {
            try {
                // Simulation de chargement depuis une API
                skins = await generateSampleSkins(127);
                filterSkins();
                updateStats();
            } catch (error) {
                console.error('Erreur de chargement des skins:', error);
                showNotification('Erreur de chargement des skins', 'error');
            }
        }
        
        function filterSkins() {
            const searchTerm = document.getElementById('skin-search').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const priceFilter = document.getElementById('price-filter').value;
            
            filteredSkins = skins.filter(skin => {
                // Recherche texte
                if (searchTerm && !skin.name.toLowerCase().includes(searchTerm) && 
                    !skin.description.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Filtre catégorie
                if (category !== 'all' && skin.category !== category) {
                    return false;
                }
                
                // Filtre prix
                if (priceFilter !== 'all') {
                    if (priceFilter === 'low' && skin.price > 100) return false;
                    if (priceFilter === 'medium' && (skin.price <= 100 || skin.price > 500)) return false;
                    if (priceFilter === 'high' && skin.price <= 500) return false;
                }
                
                return true;
            });
            
            displaySkins();
        }
        
        function displaySkins() {
            const container = document.getElementById('skins-container');
            const skinsToShow = filteredSkins.slice(0, displayedCount);
            
            if (skinsToShow.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Aucun skin trouvé</h3>
                        <p>Essayez d'autres critères de recherche</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = skinsToShow.map(skin => `
                <div class="skin-card" data-skin-id="${skin.id}" data-price="${skin.price}">
                    <div class="skin-image" style="background: ${skin.gradient}">
                        <i class="${skin.icon}"></i>
                    </div>
                    <div class="skin-info">
                        <h3 class="skin-name">${skin.name}</h3>
                        <p class="skin-description">${skin.description}</p>
                        <div class="skin-meta">
                            <span class="skin-category ${skin.category}">${skin.category}</span>
                            <span class="skin-rarity ${skin.rarity}">${skin.rarity}</span>
                        </div>
                        <div class="skin-price">
                            <i class="fas fa-gem"></i> ${skin.price.toLocaleString()} Xubor
                        </div>
                        <button class="buy-btn ${skin.owned ? 'owned' : ''}">
                            ${skin.owned ? 'ÉQUIPER' : 'ACHETER'}
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Ajouter les événements aux boutons
            document.querySelectorAll('.skin-card .buy-btn').forEach(btn => {
                btn.addEventListener('click', handleSkinAction);
            });
        }
        
        function loadMoreSkins() {
            displayedCount += 20;
            displaySkins();
        }
        
        function handleSkinAction(event) {
            const button = event.target;
            const skinCard = button.closest('.skin-card');
            const skinId = skinCard.dataset.skinId;
            const skinPrice = parseInt(skinCard.dataset.price);
            const skinName = skinCard.querySelector('.skin-name').textContent;
            
            if (button.classList.contains('owned')) {
                equipSkin(skinId, skinName);
            } else {
                buySkin(skinId, skinPrice, skinName);
            }
        }
        
        async function buySkin(skinId, price, name) {
            const user = window.authManager.getCurrentUser();
            if (!user) return;
            
            if (user.xuborBalance < price) {
                showNotification('Solde Xubor insuffisant', 'error');
                showXuborPacks();
                return;
            }
            
            if (!confirm(`Acheter "${name}" pour ${price} Xubor ?`)) {
                return;
            }
            
            try {
                showNotification(`Achat de "${name}" en cours...`, 'info');
                
                // Simulation d'achat
                await simulatePurchase(skinId, price);
                
                // Mettre à jour le solde
                window.authManager.updateXuborBalance(user.xuborBalance - price);
                loadUserData();
                
                // Mettre à jour l'interface
                const button = document.querySelector(`.skin-card[data-skin-id="${skinId}"] .buy-btn`);
                if (button) {
                    button.textContent = 'ÉQUIPER';
                    button.classList.add('owned');
                }
                
                // Ajouter au panier
                addToCart(skinId, name, price);
                
                // Mettre à jour les stats
                updateStats();
                
                showNotification(`"${name}" acheté avec succès !`, 'success');
            } catch (error) {
                showNotification('Erreur lors de l\'achat', 'error');
            }
        }
        
        async function equipSkin(skinId, name) {
            try {
                showNotification(`Équipement de "${name}"...`, 'info');
                
                // Simulation d'équipement
                await simulateEquipSkin(skinId);
                
                // Mettre à jour le skin actif
                window.authManager.updateActiveSkin(skinId);
                
                // Mettre à jour l'avatar
                const avatarImg = document.querySelector('.avatar img');
                if (avatarImg) {
                    // Ici, vous changeriez l'image du skin
                    avatarImg.style.filter = 'hue-rotate(90deg)';
                }
                
                showNotification(`"${name}" équipé !`, 'success');
            } catch (error) {
                showNotification('Erreur lors de l\'équipement', 'error');
            }
        }
        
        function addToCart(skinId, name, price) {
            cart.push({ id: skinId, name, price });
            saveCart();
            updateCartDisplay();
        }
        
        function loadCart() {
            const savedCart = localStorage.getItem('xolbor_cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
            updateCartDisplay();
        }
        
        function saveCart() {
            localStorage.setItem('xolbor_cart', JSON.stringify(cart));
        }
        
        function updateCartDisplay() {
            const cartCount = document.querySelector('.cart-count');
            const cartItems = document.getElementById('cart-items');
            const totalAmount = document.querySelector('.total-amount');
            
            cartCount.textContent = cart.length;
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="empty-cart">Votre panier est vide</p>';
                totalAmount.textContent = '0 Xubor';
            } else {
                const total = cart.reduce((sum, item) => sum + item.price, 0);
                cartItems.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <span>${item.name}</span>
                        <span>${item.price} Xubor</span>
                    </div>
                `).join('');
                totalAmount.textContent = `${total.toLocaleString()} Xubor`;
            }
        }
        
        function updateStats() {
            const ownedCount = skins.filter(s => s.owned).length;
            const discountCount = skins.filter(s => s.discount).length;
            
            document.getElementById('skin-count').textContent = skins.length;
            document.getElementById('owned-count').textContent = ownedCount;
            document.getElementById('discount-count').textContent = discountCount;
        }
        
        // Générer des skins de démonstration
        async function generateSampleSkins(count) {
            const categories = ['legendary', 'epic', 'rare', 'common'];
            const rarities = ['Légendaire', 'Épique', 'Rare', 'Commun'];
            const icons = ['fas fa-dragon', 'fas fa-robot', 'fas fa-crown', 'fas fa-hat-wizard', 
                          'fas fa-ghost', 'fas fa-knight', 'fas fa-helmet-battle', 'fas fa-mask'];
            const colors = ['#6C63FF', '#FF6584', '#36D1DC', '#10B981', '#F59E0B', '#EF4444'];
            
            return new Promise(resolve => {
                setTimeout(() => {
                    const sampleSkins = [];
                    
                    for (let i = 1; i <= count; i++) {
                        const category = categories[Math.floor(Math.random() * categories.length)];
                        const rarity = rarities[categories.indexOf(category)];
                        const icon = icons[Math.floor(Math.random() * icons.length)];
                        const color1 = colors[Math.floor(Math.random() * colors.length)];
                        const color2 = colors[Math.floor(Math.random() * colors.length)];
                        
                        const price = category === 'legendary' ? Math.floor(Math.random() * 1000) + 500 :
                                     category === 'epic' ? Math.floor(Math.random() * 500) + 200 :
                                     category === 'rare' ? Math.floor(Math.random() * 200) + 50 :
                                     Math.floor(Math.random() * 50) + 10;
                        
                        sampleSkins.push({
                            id: i,
                            name: `Skin ${i} - ${rarity}`,
                            description: `Skin ${rarity.toLowerCase()} unique`,
                            category: category,
                            rarity: rarity,
                            icon: icon,
                            gradient: `linear-gradient(135deg, ${color1}, ${color2})`,
                            price: price,
                            owned: Math.random() > 0.9, // 10% de chance d'être possédé
                            discount: Math.random() > 0.8 // 20% de chance d'être en promo
                        });
                    }
                    
                    resolve(sampleSkins);
                }, 500);
            });
        }
        
        // Simulations
        async function simulatePurchase(skinId, price) {
            return new Promise(resolve => setTimeout(() => resolve(true), 1000));
        }
        
        async function simulateEquipSkin(skinId) {
            return new Promise(resolve => setTimeout(() => resolve(true), 500));
        }
    </script>
</body>
</html>